# crash-repro

Reproduce crash in code generated by rustc for nintendo 3ds.

## Notes

* Must use 3dsxtool, it crashes on the .elf somewhere in apt code...
* Needs clean build?
  * Since crash is in regex code, probably

* Ugh! fails even when no args used with `cargo rustc`...

Trying with `RUSTFLAGS` instead of `cargo rustc --` to impact other crates

* Damn: -1 does not crash, but using the highest number (x2 even) does:

```console
$ ./bisect-repro.sh
Finding max number of LLVM passes...
++ RUSTFLAGS='-C opt-level=1 -C debuginfo=0 -C codegen-units=1 -C llvm-args=-opt-bisect-limit=-1'
++ cargo -v rustc --target armv6k-nintendo-3ds
Sending crash-repro.3dsx, 999892 bytes
400775 sent (40.08%), 36 blocks
Did it crash? [y/n] n
+ RUSTFLAGS='-C opt-level=1 -C debuginfo=0 -C codegen-units=1 -C llvm-args=-opt-bisect-limit=199998'
+ cargo -v rustc --target armv6k-nintendo-3ds
Sending crash-repro.3dsx, 1083016 bytes
423976 sent (39.15%), 38 blocks
Did it crash? [y/n] y
Max passes (199998) crash, bisecting is impossible. Exiting
```

## Bisect results

Finally! Got a real (automated) bisect result with these flags:

```sh
FLAGS=(
    -C opt-level=1
    -C debuginfo=0
    -Z verify-llvm-ir=yes
)
```

Final bisect was `-opt-bisect-limit=294912`.
<details>
<summary>Rustc failed with SIGSEGV:</summary>

```sh
rustc \
  --crate-name regex \
  --edition=2018 /Users/ianchamberlain/.cargo/registry/src/github.com-1ecc6299db9ec823/regex-1.5.5/src/lib.rs \
  --error-format=json \
  --json=diagnostic-rendered-ansi,future-incompat \
  --crate-type lib \
  --emit=dep-info,metadata,link \
  -C embed-bitcode=no \
  -C debuginfo=2 \
  --cfg 'feature="aho-corasick"' \
  --cfg 'feature="default"' \
  --cfg 'feature="memchr"' \
  --cfg 'feature="perf"' \
  --cfg 'feature="perf-cache"' \
  --cfg 'feature="perf-dfa"' \
  --cfg 'feature="perf-inline"' \
  --cfg 'feature="perf-literal"' \
  --cfg 'feature="std"' \
  --cfg 'feature="unicode"' \
  --cfg 'feature="unicode-age"' \
  --cfg 'feature="unicode-bool"' \
  --cfg 'feature="unicode-case"' \
  --cfg 'feature="unicode-gencat"' \
  --cfg 'feature="unicode-perl"' \
  --cfg 'feature="unicode-script"' \
  --cfg 'feature="unicode-segment"' \
  -C metadata=d43bcfb0bfe156b4 \
  -C extra-filename=-d43bcfb0bfe156b4 \
  --out-dir /Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/armv6k-nintendo-3ds/debug/deps \
  --target armv6k-nintendo-3ds \
  -L dependency=/Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/armv6k-nintendo-3ds/debug/deps \
  -L dependency=/Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/debug/deps \
  --extern aho_corasick=/Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/armv6k-nintendo-3ds/debug/deps/libaho_corasick-32b97d304112fb85.rmeta \
  --extern memchr=/Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/armv6k-nintendo-3ds/debug/deps/libmemchr-43ddaf7574a56279.rmeta \
  --extern regex_syntax=/Users/ianchamberlain/Documents/Development/3ds/crash-repro/target/armv6k-nintendo-3ds/debug/deps/libregex_syntax-7ba7dfda0b6f2707.rmeta \
  --cap-lints allow \
  -C opt-level=1 \
  -C debuginfo=0 \
  -Z verify-llvm-ir=yes \
  -C llvm-args=-opt-bisect-limit=294912
```

</details>

## Repro'd again

```console
Attempting 228775 passes
+ RUSTFLAGS='-C opt-level=1 -C codegen-units=1 -C lto=off -C llvm-args=-opt-bisect-limit=228775'
+ cargo -v rustc --target armv6k-nintendo-3ds
Sending crash-repro.3dsx, 1071112 bytes
422350 sent (39.43%), 38 blocks
Did it crash? [y/n] y

real    0m6.113s
user    0m0.000s
sys     0m0.000s
Attempting 228776 passes
+ RUSTFLAGS='-C opt-level=1 -C codegen-units=1 -C lto=off -C llvm-args=-opt-bisect-limit=228776'
+ cargo -v rustc --target armv6k-nintendo-3ds
Sending crash-repro.3dsx, 1070940 bytes
422159 sent (39.42%), 38 blocks
Did it crash? [y/n] n
```

### Most likely suspect

<details>
<summary>Merge disjoint stack slots on function</summary>

```txt
BISECT: running pass (228772) optimise barriers pass on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$12pop_class_op17h85de55fef5cd02bfE)
BISECT: running pass (228773) ARM Instruction Selection on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: running pass (168583) LoopInstSimplifyPass on Loop at depth 1 containing: %677<header>,%734,%688<exiting>,%691,%693<exiting>,%698<exiting>,%716,%707,%706,%703,%719,%722<exiting>,%723<exiting>,%728,%771<exiting>,%778,%741,%751,%755,%762,%786<exiting>,%796<exiting>,%806<exiting>,%816<exiting>,%889,%891,%901<exiting>,%904,%832,%840,%844,%851,%882,%885,%856,%859,%868,%879,%906<exiting>,%909,%872,%874,%828,%910<exiting>,%913,%824,%917,%914,%915,%919,%947,%949,%954,%960<exiting>,%962,%940,%782<exiting>,%966<latch>,%948,%958,%946,%858,%938,%939,%905,%779
BISECT: running pass (228774) Early Tail Duplication on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: running pass (228775) Optimize machine instruction PHIs on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: running pass (228776) Merge disjoint stack slots on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: NOT running pass (228777) Remove dead machine instructions on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: NOT running pass (228778) Early Machine Loop Invariant Code Motion on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: NOT running pass (228779) Machine Common Subexpression Elimination on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: NOT running pass (228780) Machine code sinking on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
BISECT: NOT running pass (228781) Peephole Optimizations on function (_ZN12regex_syntax3ast5parse16ParserI$LT$P$GT$19parse_with_comments17hb84b2d14834d7bfbE)
```

</details>

Looking for IR before/after the pass in `regex_syntax::ast::parse::ParserI<P>::parse_with_comments`

### The other pass with same ID

Also saw this one but seems less suspicious.

<details>
<summary>Loop Strength Reduction on loop</summary>

```txt
BISECT: running pass (228771) Transform predicated vector loops to use MVE tail predication on loop
BISECT: running pass (228772) Simplify the CFG on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
BISECT: running pass (228773) Canonicalize Freeze Instructions in Loops on loop
BISECT: running pass (228774) Loop Strength Reduction on loop
BISECT: running pass (228775) Canonicalize Freeze Instructions in Loops on loop
BISECT: running pass (228776) Loop Strength Reduction on loop
BISECT: NOT running pass (228777) Merge contiguous icmps into a memcmp on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
BISECT: NOT running pass (228778) Expand memcmp() to load/stores on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
BISECT: NOT running pass (228779) Constant Hoisting on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
BISECT: NOT running pass (228780) Partially inline calls to library functions on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
BISECT: NOT running pass (228781) Type Promotion on function (_ZN102_$LT$core..iter..adapters..map..Map$LT$I$C$F$GT$$u20$as$u20$core..iter..traits..iterator..Iterator$GT$4fold17h9314d5cd4d086cb5E)
```

</details>
